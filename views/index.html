<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Comunicados</title>
  <style>
    :root { --colors: #4fc3f7,#81c784,#ffb74d,#ba68c8,#ff8a65; }
    body { font-family: sans-serif; padding: 20px; background: #f0f2f5; }
    form, #ferramentas { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; align-items: center; }
    #resultados { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px,1fr)); gap: 15px; }
    .comunicado { position: relative; background: #fff; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); padding: 20px; border-left: 6px solid; transition: transform .2s, opacity .3s; }
    .comunicado:hover { transform: translateY(-3px); }
    .comunicado.completed { opacity: .6; background: #e8f5e9; text-decoration: line-through; }
    .numero { position: absolute; top: 12px; right: 16px; font-weight: bold; color: #555; }
    .badge { display:inline-block; padding:2px 6px; font-size:12px; border-radius:4px; color:#fff; margin-left:8px; }
    .badge.pendente { background:#f44336; } .badge.concluido { background:#4caf50; }
    .content-editable { border:1px dashed #aaa; padding:6px; background:#fffde7; cursor:text; }
    .parte2 { margin-top:12px; font-style:italic; white-space:pre-line; }
    .btn-group { display:flex; flex-wrap:wrap; gap:6px; margin-top:12px; }
    .input-cartorio { padding:4px; flex:1; }
  </style>
</head>
<body>
  <h1>Processador de Comunicados</h1>

  <form id="formUpload">
    <input type="file" name="pdf" accept="application/pdf" required />
    <select id="escreventeSelect">
      <option value="">Selecionar escrevente</option>
      <option>Edjan Santos Melo</option>
      <option>Gabriela Maria Gama de Almeida</option>
    </select>
    <button type="submit">Enviar PDF</button>
    <button type="button" id="exportarPDF">üè∑Ô∏è Exportar Etiquetas</button>
  </form>

  <div id="ferramentas">
    <input id="buscaComunicados" placeholder="üîç Buscar..." />
    <button id="filtroPendentes">Mostrar s√≥ pendentes</button>
  </div>

  <div id="resultados"></div>
  <div id="resumoErros"></div>

  <script>
    const cores = getComputedStyle(document.documentElement).getPropertyValue('--colors')
      .split(',').map(c => c.trim());
    const form = document.getElementById('formUpload');
    const select = document.getElementById('escreventeSelect');
    const busca = document.getElementById('buscaComunicados');
    const filtroBtn = document.getElementById('filtroPendentes');
    const container = document.getElementById('resultados');
    let escrevente = '', pendentesOnly = false;

    select.addEventListener('change', e => escrevente = e.target.value);
    filtroBtn.addEventListener('click', () => {
      pendentesOnly = !pendentesOnly;
      filtroBtn.textContent = pendentesOnly ? 'Mostrar todos' : 'Mostrar s√≥ pendentes';
      filtrar();
    });
    busca.addEventListener('input', filtrar);

    function carregarCompletos() {
      return JSON.parse(localStorage.getItem('completos')||'[]');
    }
    function salvarCompletos(list) {
      localStorage.setItem('completos', JSON.stringify(list));
    }
    function filtrar() {
      const q = busca.value.toLowerCase();
      document.querySelectorAll('.comunicado').forEach(div => {
        const texto = div.textContent.toLowerCase();
        const isDone = div.classList.contains('completed');
        div.style.display = (texto.includes(q) && (!pendentesOnly || !isDone)) ? '' : 'none';
      });
    }

    function toggleConcluido(div, id, btn) {
      const lista = carregarCompletos();
      const idx = lista.indexOf(id);
      const done = idx > -1;
      if (done) lista.splice(idx,1); else lista.push(id);
      salvarCompletos(lista);
      div.classList.toggle('completed', !done);
      btn.textContent = done ? '‚úÖ Concluir' : 'üîÑ Desmarcar';
      filtrar();
    }

    form.addEventListener('submit', async e => {
      e.preventDefault();
      const res = await fetch('/upload',{ method:'POST', body:new FormData(form) });
      const { comunicados, erros } = await res.json();
      container.innerHTML = '';
      document.getElementById('resumoErros').innerHTML = '';

      const completos = carregarCompletos();

      comunicados.forEach((com, i) => {
        const div = document.createElement('div');
        div.className = 'comunicado';
        div.dataset.id = com.id;
        if (completos.includes(com.id)) div.classList.add('completed');
        div.style.borderLeftColor = cores[i % cores.length];

        const num = document.createElement('span');
        num.className = 'numero';
        num.textContent = `#${i+1}`;
        div.appendChild(num);

        const badge = document.createElement('span');
        badge.className = 'badge ' + (completos.includes(com.id)?'concluido':'pendente');
        badge.textContent = completos.includes(com.id)?'Conclu√≠do':'Pendente';
        num.after(badge);

        const p1 = document.createElement('div');
        p1.className = 'content-editable';
        p1.contentEditable = 'false';
        p1.innerHTML = `${com.parte1}${escrevente?` Dou f√©, ${escrevente}.`:''}`;
        div.appendChild(p1);

        const p2 = document.createElement('div');
        p2.className = 'parte2';
        p2.textContent = com.parte2;
        div.appendChild(p2);

        const grupo = document.createElement('div');
        grupo.className = 'btn-group';

        const btE = document.createElement('button');
        btE.textContent = 'üìù Editar';
        btE.onclick = () => {
          const ed = p1.contentEditable === 'true';
          p1.contentEditable = ed ? 'false':'true';
          if (!ed) p1.focus();
        };
        grupo.appendChild(btE);

        const btC = document.createElement('button');
        btC.textContent = completos.includes(com.id)?'üîÑ Desmarcar':'‚úÖ Concluir';
        btC.onclick = () => toggleConcluido(div, com.id, btC);
        grupo.appendChild(btC);

        if (com.erros.includes('Cart√≥rio de origem ausente')) {
          const inp = document.createElement('input');
          inp.className = 'input-cartorio';
          inp.placeholder = 'Ex: 13¬∫ Of√≠cio';
          grupo.appendChild(inp);

          const btA = document.createElement('button');
          btA.textContent = '‚ûï Cart√≥rio';
          btA.onclick = () => adicionarCartorio(btA);
          grupo.appendChild(btA);

          const btCp = document.createElement('button');
          btCp.textContent = 'üìã Nome';
          btCp.onclick = e => copiarNome(e, com.nome_registrado);
          grupo.appendChild(btCp);
        }

        div.appendChild(grupo);

        if (com.erros.length) {
          const erdiv = document.createElement('div');
          erdiv.className = 'erros';
          erdiv.textContent = '‚ö†Ô∏è ' + com.erros.join(', ');
          div.appendChild(erdiv);
        }

        container.appendChild(div);
      });

      if (erros.length) {
        document.getElementById('resumoErros').innerHTML = `
          <div class="resumo-erros">
            <strong>${erros.length} erro(s):</strong><br>
            ${erros.map(e=>`#${e.id}: ${e.erros.join(', ')}`).join('<br>')}
          </div>`;
      }

      document.getElementById('exportarPDF').onclick = async () => {
        const cards = [...container.children].filter(d=>d.style.display!=='none');
        const payload = cards.map(div=>{
          const t1 = div.querySelector('.content-editable').textContent;
          const t2 = div.querySelector('.parte2').textContent;
          return { texto: `${t1}\n${t2}` };
        });
        const r = await fetch('/gerar-etiquetas',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ comunicados: payload })
        });
        if (!r.ok) return alert('Erro ao gerar etiquetas.');
        const blob = await r.blob();
        const url  = URL.createObjectURL(blob);
        const a    = document.createElement('a');
        a.href     = url;
        a.download = 'etiquetas.pdf';
        a.click();
      };
    });

    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî fun√ß√µes ausentes ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî

    function copiarNome(event, nome) {
      const btn = event.target;
      if (!nome) {
        btn.textContent = '‚ùå Nome n√£o encontrado';
        btn.disabled = true;
        setTimeout(() => {
          btn.textContent = 'üìã Nome';
          btn.disabled = false;
        }, 2000);
        return;
      }
      navigator.clipboard.writeText(nome).then(() => {
        const orig = btn.textContent;
        btn.textContent = '‚úÖ Copiado!';
        btn.disabled = true;
        setTimeout(() => {
          btn.textContent = orig;
          btn.disabled = false;
        }, 2000);
      });
    }

    function adicionarCartorio(btn) {
      const input = btn.parentElement.querySelector('.input-cartorio');
      const valor = input.value.trim();
      if (!valor) return alert('Preencha o cart√≥rio.');
      const card = btn.closest('.comunicado');
      const p2 = card.querySelector('.parte2');
      if (!/Cart√≥rio de origem:/.test(p2.textContent)) {
        p2.textContent += `\nCart√≥rio de origem: ${valor}`;
      } else {
        p2.textContent = p2.textContent.replace(
          /Cart√≥rio de origem:[^\n]*/,
          `Cart√≥rio de origem: ${valor}`
        );
      }
      const err = card.querySelector('.erros');
      if (err && err.textContent.includes('Cart√≥rio de origem ausente')) err.remove();
      btn.textContent = '‚úèÔ∏è Editar cart√≥rio';
      btn.onclick = () => editarCartorio(btn, valor);
    }

    function editarCartorio(btn, valorAntigo) {
      const cont = btn.parentElement;
      const input = document.createElement('input');
      input.type = 'text'; input.value = valorAntigo; input.className = 'input-cartorio';
      const salvar = document.createElement('button');
      salvar.textContent = '‚úÖ Salvar';
      salvar.onclick = () => salvarCartorio(salvar, input.value, valorAntigo);
      cont.insertBefore(input, btn);
      cont.insertBefore(salvar, btn);
      btn.remove();
    }

    function salvarCartorio(btn, novo, antigo) {
      const card = btn.closest('.comunicado');
      const p2 = card.querySelector('.parte2');
      p2.textContent = p2.textContent.replace(
        `Cart√≥rio de origem: ${antigo}`,
        `Cart√≥rio de origem: ${novo}`
      );
      const cont = btn.parentElement;
      cont.querySelectorAll('.input-cartorio').forEach(el => el.remove());
      btn.remove();
      const edt = document.createElement('button');
      edt.textContent = '‚úèÔ∏è Editar cart√≥rio';
      edt.onclick = () => editarCartorio(edt, novo);
      cont.appendChild(edt);
    }
  </script>
</body>
</html>
