<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <title>Comunicados</title>
  <style>
    :root { --colors: #4fc3f7,#81c784,#ffb74d,#ba68c8,#ff8a65; }
    body { font-family:sans-serif; padding:20px; background:#f0f2f5; }
    h1 { margin-bottom:10px; }
    #top-bar, #ferramentas, .btn-group {
      display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-bottom:15px;
    }
    #sessionContainer, #formUpload, #ferramentas, #controls-load {
      background:#fff; padding:12px; border-radius:6px; box-shadow:0 1px 3px rgba(0,0,0,0.1);
    }
    select, input[type="file"], input[type="text"], button {
      padding:6px 10px; font-size:14px; border-radius:4px; border:1px solid #ccc;
    }
    button { background:#1976d2; color:#fff; cursor:pointer; }
    button:hover { background:#1565c0; }
    #controls-load button { background:#0288d1; }
    #controls-load button:hover { background:#0277bd; }
    #resultados {
      display:grid; grid-template-columns:repeat(auto-fill,minmax(340px,1fr)); gap:15px;
    }
    #resumoErros {
      margin-top:20px; background:#fff3cd; padding:10px; border-radius:6px;
    }
    .comunicado {
      position:relative; background:#fff; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1);
      padding:20px; border-left:6px solid; transition:transform .2s,opacity .3s;
    }
    .comunicado:hover { transform:translateY(-3px); }
    .comunicado.completed {
      opacity:.6; background:#e8f5e9; text-decoration:line-through;
    }
    .numero {
      position:absolute; top:12px; right:16px; font-weight:bold; color:#555;
    }
    .badge {
      display:inline-block; padding:2px 6px; font-size:12px; border-radius:4px; color:#fff; margin-left:8px;
    }
    .badge.pendente { background:#f44336; }
    .badge.concluido { background:#4caf50; }
    .content-editable {
      border:1px dashed #aaa; padding:6px; background:#fffde7; cursor:text;
    }
    .content-editable[contenteditable="true"] {
      background:#fff3cd; outline:2px dashed #ffc107;
    }
    .parte2 { margin-top:12px; font-style:italic; white-space:pre-line; }
    .btn-group { margin-top:12px; gap:6px; }
    .input-cartorio {
      padding:6px; font-size:13px; flex:1; min-width:120px;
    }
  </style>
</head>
<body>

  <h1>Processador de Comunicados</h1>

  <div id="top-bar">
    <form id="formUpload">
      <input id="fileInput" type="file" name="pdf" accept="application/pdf" required />
      <select id="escreventeSelect">
        <option value="">Selecionar escrevente</option>
        <option>Edjan Santos Melo</option>
        <option>Gabriela Maria Gama de Almeida</option>
      </select>
      <button type="submit">Enviar PDF</button>
      <button type="button" id="exportarPDF">üè∑Ô∏è Exportar Etiquetas</button>
    </form>
  </div>

  <div id="controls-load">
    <label for="sessionSelect"><strong>Continuar PDF:</strong></label>
    <select id="sessionSelect">
      <option value="">Nova Sess√£o</option>
    </select>
    <button id="btnCarregarSessao">üîÑ Carregar Sess√£o Selecionada</button>
  </div>

  <div id="ferramentas">
    <input id="buscaComunicados" placeholder="üîç Buscar..." />
    <button id="filtroPendentes">Mostrar s√≥ pendentes</button>
  </div>

  <div id="resultados"></div>
  <div id="resumoErros"></div>

  <script>
    const cores = getComputedStyle(document.documentElement).getPropertyValue('--colors').split(',').map(c=>c.trim());
    const TTL = 10*24*60*60*1000;
    let currentSessionId = null;

    const form = document.getElementById('formUpload');
    const fileInput = document.getElementById('fileInput');
    const sessionSelect = document.getElementById('sessionSelect');
    const loadBtn = document.getElementById('btnCarregarSessao');
    const escreventeSelect = document.getElementById('escreventeSelect');
    const busca = document.getElementById('buscaComunicados');
    const filtroBtn = document.getElementById('filtroPendentes');
    const container = document.getElementById('resultados');
    const resumoEl = document.getElementById('resumoErros');
    let escrevente='', pendentesOnly=false;

    function pruneSessions() {
      const now = Date.now();
      const all = JSON.parse(localStorage.getItem('sessions')||'[]');
      const valid = all.filter(s=> now - s.timestamp < TTL);
      all.filter(s=> now - s.timestamp >= TTL)
         .forEach(s=> localStorage.removeItem('session_'+s.id));
      localStorage.setItem('sessions', JSON.stringify(valid));
      return valid;
    }

    function populateSessionSelect() {
      sessionSelect.innerHTML = '<option value="">Nova Sess√£o</option>';
      pruneSessions().forEach(s=>{
        const o = document.createElement('option');
        o.value = s.id;
        o.textContent = s.label;
        sessionSelect.appendChild(o);
      });
    }

    function saveSession(id, label, data) {
      const now = Date.now();
      const list = pruneSessions();
      list.push({id, label, timestamp: now});
      localStorage.setItem('sessions', JSON.stringify(list));
      localStorage.setItem('session_'+id, JSON.stringify(data));
      populateSessionSelect();
    }

    function clearUI() {
      container.innerHTML = '';
      resumoEl.innerHTML = '';
      currentSessionId = null;
    }

    function renderComunicados(comunicados, erros, completosSet) {
      container.innerHTML = '';
      resumoEl.innerHTML = '';
      comunicados.forEach((com, i)=>{
        const div = document.createElement('div');
        div.className = 'comunicado';
        div.dataset.id = com.id;
        if(completosSet.has(com.id)) div.classList.add('completed');
        div.style.borderLeftColor = cores[i % cores.length];

        const num = document.createElement('span');
        num.className = 'numero';
        num.textContent = `#${i+1}`;
        div.appendChild(num);

        const badge = document.createElement('span');
        badge.className = 'badge ' + (completosSet.has(com.id)?'concluido':'pendente');
        badge.textContent = completosSet.has(com.id)?'Conclu√≠do':'Pendente';
        num.after(badge);

        const p1 = document.createElement('div');
        p1.className = 'content-editable';
        p1.contentEditable = 'false';
        p1.innerHTML = `${com.parte1}${escrevente?` Dou f√©, ${escrevente}.`:''}`;
        div.appendChild(p1);

        p1.addEventListener('blur', () => {
          if (p1.contentEditable === 'true') {
            p1.contentEditable = 'false';
            persistSession();
          }
        });

        const p2 = document.createElement('div');
        p2.className = 'parte2';
        p2.textContent = com.parte2;
        div.appendChild(p2);

        const grp = document.createElement('div');
        grp.className = 'btn-group';

        const btE = document.createElement('button');
        btE.textContent = 'üìù Editar';
        btE.onclick = ()=>{
          const ed = p1.contentEditable==='true';
          p1.contentEditable = ed?'false':'true';
          if(!ed) p1.focus();
          else persistSession();              // SALVA AP√ìS EDITAR
        };
        grp.appendChild(btE);

        const btC = document.createElement('button');
        btC.textContent = completosSet.has(com.id)?'üîÑ Desmarcar':'‚úÖ Concluir';
        btC.onclick = ()=> toggleConcluido(div, com.id, btC);
        grp.appendChild(btC);

        if(com.erros.includes('Cart√≥rio de origem ausente')){
          const inp = document.createElement('input');
          inp.className = 'input-cartorio';
          inp.placeholder = 'Ex: 13¬∫ Of√≠cio';

          const btA = document.createElement('button');
          btA.textContent = '‚ûï Cart√≥rio';
          btA.onclick = ()=>{
            adicionarCartorio(btA);
            persistSession();              // SALVA AP√ìS ADICIONAR
          };

          const btCp = document.createElement('button');
          btCp.textContent = 'üìã Nome';
          btCp.onclick = e=> copiarNome(e, com.nome_registrado);

          grp.append(inp, btA, btCp);
        }

        div.appendChild(grp);

        if(com.erros.length){
          const erdiv = document.createElement('div');
          erdiv.className = 'erros';
          erdiv.textContent = '‚ö†Ô∏è ' + com.erros.join(', ');
          div.appendChild(erdiv);
        }

        container.appendChild(div);
      });

      if(erros.length){
        resumoEl.innerHTML = `<div class="resumo-erros">
          <strong>${erros.length} erro(s):</strong><br>
          ${erros.map(e=>`#${e.id}: ${e.erros.join(', ')}`).join('<br>')}
        </div>`;
      }

      filtrar();
    }

    function loadSession(id) {
      clearUI();
      fileInput.disabled = true;
      fileInput.value = '';
      const raw = localStorage.getItem('session_'+id);
      if(!raw) return;
      const sess = JSON.parse(raw);
      renderComunicados(sess.comunicados, sess.erros, new Set(sess.completos));
      currentSessionId = id;
    }

    sessionSelect.addEventListener('change', e=>{
      if(!e.target.value){
        clearUI();
        fileInput.disabled = false;
      }
    });

    loadBtn.addEventListener('click', ()=>{
      const id = sessionSelect.value;
      if(!id){
        alert('Selecione uma sess√£o primeiro.');
        return;
      }
      loadSession(id);
    });

    escreventeSelect.onchange = e=> escrevente = e.target.value;
    filtroBtn.onclick = ()=>{
      pendentesOnly = !pendentesOnly;
      filtroBtn.textContent = pendentesOnly?'Mostrar todos':'Mostrar s√≥ pendentes';
      filtrar();
    };
    busca.oninput = filtrar;
    function filtrar(){
      const q = busca.value.toLowerCase();
      document.querySelectorAll('.comunicado').forEach(div=>{
        const txt = div.textContent.toLowerCase();
        const done = div.classList.contains('completed');
        div.style.display = (txt.includes(q) && (!pendentesOnly || !done))?'':'none';
      });
    }

    function carregarCompletos(){
      return JSON.parse(localStorage.getItem('completos')||'[]');
    }
    function salvarCompletos(list){
      localStorage.setItem('completos', JSON.stringify(list));
    }
    function toggleConcluido(div, id, btn){
      const lista = carregarCompletos();
      const idx = lista.indexOf(id);
      const done = idx > -1;
      if(done) lista.splice(idx,1); else lista.push(id);
      salvarCompletos(lista);
      div.classList.toggle('completed', !done);
      btn.textContent = done?'‚úÖ Concluir':'üîÑ Desmarcar';
      filtrar();
      if(currentSessionId){
        const sess = JSON.parse(localStorage.getItem('session_'+currentSessionId));
        sess.completos = lista;
        localStorage.setItem('session_'+currentSessionId, JSON.stringify(sess));
      }
    }

    function copiarNome(e, nome){
      const btn = e.target;
      if(!nome){
        btn.textContent = '‚ùå Nome n√£o encontrado';
        btn.disabled = true;
        return setTimeout(()=>{
          btn.textContent = 'üìã Nome'; btn.disabled = false;
        },2000);
      }
      navigator.clipboard.writeText(nome).then(()=>{
        const orig = btn.textContent;
        btn.textContent = '‚úÖ Copiado!';
        btn.disabled = true;
        setTimeout(()=>{
          btn.textContent = orig; btn.disabled = false;
        },2000);
      });
    }

    function adicionarCartorio(btn){
      const inp = btn.parentElement.querySelector('.input-cartorio');
      const v = inp.value.trim();
      if(!v) return alert('Preencha o cart√≥rio.');
      const card = btn.closest('.comunicado');
      const p2 = card.querySelector('.parte2');
      if(!/Cart√≥rio de origem:/.test(p2.textContent))
        p2.textContent += `\nCart√≥rio de origem: ${v}`;
      else
        p2.textContent = p2.textContent.replace(/Cart√≥rio de origem:[^\n]*/, `Cart√≥rio de origem: ${v}`);
      card.querySelector('.erros')?.remove();
      btn.textContent = '‚úèÔ∏è Editar cart√≥rio';
      btn.onclick = ()=> {
        editarCartorio(btn, v);
        persistSession();            // SALVA AP√ìS SALVAR CART√ìRIO
      };
    }

    function editarCartorio(btn, old){
      const cont = btn.parentElement;
      const inp = document.createElement('input');
      inp.type = 'text'; inp.value = old; inp.className = 'input-cartorio';
      const sv = document.createElement('button'); sv.textContent = '‚úÖ Salvar';
      sv.onclick = ()=> salvarCartorio(sv, inp.value, old);
      cont.insertBefore(inp, btn);
      cont.insertBefore(sv, btn);
      btn.remove();
    }

    function salvarCartorio(btn, nw, old){
      const card = btn.closest('.comunicado');
      const p2 = card.querySelector('.parte2');
      p2.textContent = p2.textContent.replace(`Cart√≥rio de origem: ${old}`, `Cart√≥rio de origem: ${nw}`);
      const cont = btn.parentElement;
      cont.querySelectorAll('.input-cartorio').forEach(x=>x.remove());
      btn.remove();
      const ed = document.createElement('button');
      ed.textContent = '‚úèÔ∏è Editar cart√≥rio';
      ed.onclick = ()=> {
        editarCartorio(ed, nw);
        persistSession();          // SALVA AP√ìS SALVAR CART√ìRIO
      };
      cont.appendChild(ed);
    }

    function gerarEtiquetas(){
      const cards = [...container.children].filter(d=>d.style.display!=='none');
      const payload = cards.map(div=>({
        texto: `${div.querySelector('.content-editable').textContent}\n${div.querySelector('.parte2').textContent}`
      }));
      fetch('/gerar-etiquetas',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({comunicados:payload})
      })
      .then(r=>{ if(!r.ok) throw new Error(); return r.blob(); })
      .then(blob=>{
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download='etiquetas.pdf'; a.click();
      })
      .catch(()=>alert('Erro ao gerar etiquetas.'));
    }

    document.getElementById('exportarPDF').addEventListener('click', gerarEtiquetas);

    form.addEventListener('submit', async e=>{ /* ... */ });

    function persistSession() {
      if (!currentSessionId) return;
      const key = 'session_' + currentSessionId;
      const sess = JSON.parse(localStorage.getItem(key));

      sess.comunicados = sess.comunicados.map(orig => {
        const div = container.querySelector(`[data-id="${orig.id}"]`);
        if (!div) return orig;

        const newParte1 = div.querySelector('.content-editable').innerHTML;
        const newParte2 = div.querySelector('.parte2').textContent.trim();

        // s√≥ remove ‚ÄúCart√≥rio de origem ausente‚Äù se voc√™ j√° adicionou um cart√≥rio
        const newErros = orig.erros.filter(err => {
          if (err === 'Cart√≥rio de origem ausente') {
            return !newParte2.includes('Cart√≥rio de origem:');
          }
          return true;
        });

        return {
          ...orig,
          parte1: newParte1,
          parte2: newParte2,
          erros: newErros
        };
      });

      localStorage.setItem(key, JSON.stringify(sess));
    }


    form.addEventListener('submit', async e => {
    e.preventDefault();

    // se estiver carregando sess√£o, n√£o faz upload
    const sid = sessionSelect.value;
    if (sid && !fileInput.files.length) {
      loadSession(sid);
      return;
    }

    // faz o upload do PDF
    const res = await fetch('/upload', {
      method: 'POST',
      body: new FormData(form)
    });
    if (!res.ok) {
      return alert('Erro ao enviar PDF.');
    }
    const { comunicados, erros } = await res.json();

    // renderiza e salva sess√£o
    const completos = new Set(carregarCompletos());
    renderComunicados(comunicados, erros, completos);

    const label = `${fileInput.files[0].name} (${new Date().toLocaleDateString()})`;
    const newId = Date.now().toString();
    saveSession(newId, label, {
      comunicados,
      erros,
      completos: Array.from(completos)
    });
    currentSessionId = newId;
    sessionSelect.value = newId;
    fileInput.disabled = true;
  });

    populateSessionSelect();
  </script>
</body>
</html>
